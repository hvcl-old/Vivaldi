import numpy
from scipy import misc

# function that takes long time
def heatflow(image, x, y):
	a = laplacian(image, x, y)
	ret = point_query_2d(image, x, y)

	niter = 1000

	dt =  0.5 / niter

	for i in range(niter):
		ret = ret + dt*a

	return ret

def diff(a, b, x, y):
	
	ret = point_query_2d(a, x, y) - point_query_2d(b, x, y)

	niter = 1000

	dt =  0.5 / niter

	for i in range(niter):
		ret = ret + dt*ret

	return ret

def main():

	print "+++ Loading image ..."
#	image = load_data_2d(DATA_PATH+'flower.jpg',float)
	image = load_data_2d(DATA_PATH+'/Tile_001.png', float)
#	image = misc.lena()
	print "+++ Loading Done!"

	# GPU test

	print "+++ Task Parallelism test +++"

	glist = get_GPU_list(2)
# Task dependency graph
#
# image ---> a -------------+-> e
#        |                  |
#        +-> b --> c --> d -+ 
#

	a = heatflow(image, x, y).range(image).dtype(image,float).execid(glist)

	b = heatflow(image, x, y).range(image).dtype(image,float).execid(glist)

	c = heatflow(b, x, y).range(image).dtype(b,float).execid(glist)
#	b = heatflow(b, x, y).range(image).dtype(b,float).execid(glist)

	d = heatflow(c, x, y).range(image).dtype(c,float).execid(glist)
#	b = heatflow(b, x, y).range(image).dtype(b,float).execid(glist)

	e = diff(a, d, x, y).range(image).dtype(a,float).dtype(d,float).execid(glist)

#	e = a

	synchronize()
	print "+++ Done! +++"
	print "   "

	print "+++ Save image +++"
#	save_image(e, "result-taskparallel.png")
	print "+++ Done! +++"
